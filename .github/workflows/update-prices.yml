import os
import csv
import io
from decimal import Decimal, getcontext
import requests
import gspread

getcontext().prec = 28

PROVIDER_URL_DEFAULT = "https://store.dreamlove.es/dyndata/exportaciones/csvzip/catalog_1_50_125_2_eb10a792c0336bc695e2b0ec29d88402_csv_plain.csv?tkn=28cc4e818950d81c1d322225464f29e4a8fd9381c561188ba29ff5699cc273fd"

ROUNDING_MULTIPLE = int(os.getenv("ROUNDING_MULTIPLE", "5"))
ROUNDING_STRATEGY = os.getenv("ROUNDING_STRATEGY", "ceil").strip().lower()
ROUNDING_AVOID_HUNDREDS = os.getenv("ROUNDING_AVOID_HUNDREDS", "true").strip().lower() in ("true", "1", "yes")
if ROUNDING_MULTIPLE <= 0:
    ROUNDING_MULTIPLE = 5

def parse_decimal(s):
    if s is None:
        return None
    t = str(s).strip()
    if not t:
        return None
    t = t.replace(" ", "")
    if "," in t and "." not in t:
        t = t.replace(",", ".")
    try:
        return Decimal(t)
    except Exception:
        return None

def compute_price(neto):
    raw = Decimal(neto) * Decimal("1.0727")
    m = Decimal(ROUNDING_MULTIPLE)
    if raw % m == 0:
        price = int(raw)
    else:
        if ROUNDING_STRATEGY == "ceil":
            price = int(((raw // m) + 1) * m)
        else:
            price = int(((raw // m) + 1) * m)
    if ROUNDING_AVOID_HUNDREDS and price % 100 == 0:
        price += ROUNDING_MULTIPLE
    return price

def detect_delimiter(sample):
    first_line = sample.splitlines()[0] if sample else ""
    sc = first_line.count(";")
    cc = first_line.count(",")
    if sc > cc:
        return ";"
    return ","

def load_provider_map(url, ref_col, neto_col):
    r = requests.get(url, timeout=120)
    r.raise_for_status()
    text = r.content.decode("utf-8", errors="ignore")
    delim = detect_delimiter(text[:1000])
    reader = csv.DictReader(io.StringIO(text), delimiter=delim)
    m = {}
    for row in reader:
        ref = row.get(ref_col)
        neto = parse_decimal(row.get(neto_col))
        if not ref or neto is None:
            continue
        m[str(ref).strip()] = neto
    return m

def open_worksheet(creds_json, sheet_id, sheet_name):
    import json
    data = json.loads(creds_json)
    gc = gspread.service_account_from_dict(data)
    sh = gc.open_by_key(sheet_id)
    if sheet_name:
        return sh.worksheet(sheet_name)
    return sh.get_worksheet(0)

def find_column_index(header, name):
    name_l = name.strip().lower()
    for i, h in enumerate(header, start=1):
        if str(h).strip().lower() == name_l:
            return i
    return None

def shopify_graphql(store, token, version, query, variables):
    url = f"https://{store}/admin/api/{version}/graphql.json"
    headers = {"X-Shopify-Access-Token": token, "Content-Type": "application/json"}
    r = requests.post(url, json={"query": query, "variables": variables}, headers=headers, timeout=60)
    r.raise_for_status()
    return r.json()

def shopify_find_variant_id_by_sku(store, token, version, sku):
    q = "query($q: String!) { productVariants(first: 1, query: $q) { edges { node { id sku } } } }"
    data = shopify_graphql(store, token, version, q, {"q": f"sku:{sku}"})
    pv = data.get("data", {}).get("productVariants", {}).get("edges", [])
    if not pv:
        return None
    gid = pv[0].get("node", {}).get("id")
    if not gid:
        return None
    try:
        return gid.split("/")[-1]
    except Exception:
        return None

def shopify_get_variant(store, token, version, variant_id):
    url = f"https://{store}/admin/api/{version}/variants/{variant_id}.json"
    headers = {"X-Shopify-Access-Token": token}
    r = requests.get(url, headers=headers, timeout=60)
    r.raise_for_status()
    return r.json().get("variant", {})

def shopify_update_variant_price(store, token, version, variant_id, price):
    url = f"https://{store}/admin/api/{version}/variants/{variant_id}.json"
    headers = {"X-Shopify-Access-Token": token, "Content-Type": "application/json"}
    payload = {"variant": {"id": int(variant_id), "price": str(price)}}
    r = requests.put(url, json=payload, headers=headers, timeout=60)
    r.raise_for_status()
    return True

def update_prices_in_shopify(ws, provider_map, sku_col_name, store, token, version):
    rows = ws.get_all_values()
    if not rows:
        return {"updated": 0, "skipped_compare": 0, "missing_neto": 0, "not_found": 0}
    header = rows[0]
    sku_idx = find_column_index(header, sku_col_name)
    if sku_idx is None:
        return {"updated": 0, "skipped_compare": 0, "missing_neto": 0, "not_found": 0}
    updated = 0
    skipped_compare = 0
    missing_neto = 0
    not_found = 0
    for i in range(1, len(rows)):
        row = rows[i]
        sku = row[sku_idx - 1] if sku_idx - 1 < len(row) else ""
        sku_key = str(sku).strip()
        neto = provider_map.get(sku_key)
        if neto is None:
            missing_neto += 1
            continue
        price = compute_price(neto)
        vid = shopify_find_variant_id_by_sku(store, token, version, sku_key)
        if not vid:
            not_found += 1
            continue
        var = shopify_get_variant(store, token, version, vid)
        cap = var.get("compare_at_price")
        if cap is not None and str(cap).strip() != "":
            skipped_compare += 1
            continue
        try:
            shopify_update_variant_price(store, token, version, vid, price)
            updated += 1
        except Exception:
            continue
    return {"updated": updated, "skipped_compare": skipped_compare, "missing_neto": missing_neto, "not_found": not_found}

def main():
    provider_url = os.getenv("PROVIDER_URL", PROVIDER_URL_DEFAULT)
    ref_col = os.getenv("PROVIDER_REFERENCE_COLUMN", "referencia")
    neto_col = os.getenv("PROVIDER_NET_PRICE_COLUMN", "precio_neto")
    sku_col = os.getenv("SKU_COLUMN", "SKU")
    sheet_id = os.getenv("SHEET_ID")
    sheet_name = os.getenv("SHEET_NAME")
    creds_json = os.getenv("GOOGLE_SERVICE_ACCOUNT_JSON")
    shop_store = os.getenv("SHOPIFY_STORE")
    shop_token = os.getenv("SHOPIFY_ACCESS_TOKEN")
    shop_version = os.getenv("SHOPIFY_API_VERSION", "2025-01")
    if not creds_json or not sheet_id:
        print("Missing GOOGLE_SERVICE_ACCOUNT_JSON or SHEET_ID")
        return
    provider_map = load_provider_map(provider_url, ref_col, neto_col)
    ws = open_worksheet(creds_json, sheet_id, sheet_name)
    if shop_store and shop_token:
        sres = update_prices_in_shopify(ws, provider_map, sku_col, shop_store, shop_token, shop_version)
        print(f"shopify_updated={sres['updated']} shopify_skipped_compare={sres['skipped_compare']} shopify_missing_neto={sres['missing_neto']} shopify_not_found={sres['not_found']}")
    else:
        print("Missing SHOPIFY_STORE or SHOPIFY_ACCESS_TOKEN")

if __name__ == "__main__":
    main()
